<!doctype html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="author" content="Juan Salvador Aleixandre" />
    <meta name="date" content="09/11/2015"/>
    <meta name="generator" content="easybook 4.9.0"/>

    <title>Pasos seguidos para crear un sistema de backup online usando el BitTorrent y una Cubietruck (Cubieboard 3) | Blog Cosillas de Juansal</title>

    <link rel="stylesheet" href="./css/easybook.css" />

</head>

<body class="item chapter">
<div class="container">
<div class="menu">
    <div class="row">
        <h1 class="span9"><a href="./index.html">Blog Cosillas de Juansal</a></h1>
        <p class="span3">
                        <a href="./capitulo-51.html"><span>&larr;</span> Anterior</a>
            
                        <a href="./capitulo-52.html">Siguiente <span>&rarr;</span></a>
                    </p>
    </div>
</div>

<div class="row">
    <div class="span9">
        <h1 id="2014_02"><span>Capítulo 5.2</span> Pasos seguidos para crear un sistema de backup online usando el BitTorrent y una Cubietruck (Cubieboard 3)</h1>
        <h2 id="consideraciones-iniciales-sobre-el-documento">5.2.1 Consideraciones iniciales sobre el documento</h2>

<p>En este documento se detallan los pasos seguidos para instalar el Lubuntu en una Cubietruck (Cubieboard 3) y el BitTorrent Sync.
Los pasos detallados son los que yo he seguido y que a mí me han funcionado.
En mi caso en la tarjeta SD está el sistema operativo y las aplicaciones, en el disco duro sólo se encuentran los ficheros del BitTorrent Sync.</p>

<h2 id="instalacion-del-sistema-operativo-en-tarjeta-sd">5.2.2 Instalación del sistema operativo en tarjeta SD</h2>

<p>En este apartado se detallan los pasos para realizar la instalación del Lubuntu dentro de la tarjeta SD.</p>

<h3 id="consideraciones-iniciales">5.2.2.1 Consideraciones iniciales</h3>

<p>Para realizar los pasos detallados a continuación se ha utilizado un sistema Ubuntu.
La tarjeta SD estaba montada como <code>sdb</code>.</p>

<h3 id="instalacion-del-sistema-operativo-dentro-de-la-tarjeta-sd">5.2.2.2 Instalación del sistema operativo dentro de la tarjeta SD</h3>

<p>El sistema operativo sobre el que se han realizado las acciones siguientes ha sido el Lubuntu para la cubieboard, aunque la versión de linux sobre la que se ejecuten no debería de importar.</p>

<p>Los pasos seguidos han sido los siguientes:</p>

<ul>
<li>Asignación de la ruta en la que está la tarjeta a una variable del sistema</li>
</ul>

<p><code>bash
card=/dev/sdb</code></p>

<ul>
<li>Limpieza de la tarjeta SD:</li>
</ul>

<p><code>bash
sudo dd if=/dev/zero of=${card} bs=1024 seek=544 count=128</code></p>

<ul>
<li>Hacer la tarjeta SD arrancable:</li>
</ul>

<p><code>bash
sudo dd if=u-boot-sunxi-with-spl-ct-20131102.bin of=$card bs=1024 seek=8</code></p>

<ul>
<li>Particionado de la tarjeta SD: Esta se ha de particionar en 2 particiones, la primera de 64Mb. (2048 sectores) y la segunda del resto del tamaño. Ejemplo de como se queda:</li>
</ul>

<p><code>bash
 Device Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048      133119       65536   83  Linux
/dev/sdb2          133120    15278079     7572480   83  Linux</code></p>

<p>Para poder realizar la modificación de la partición se ha usado el comando siguiente:</p>

<p><code>bash
sudo fdisk $card</code></p>

<ul>
<li>Formateado de las particiones creadas:</li>
</ul>

<p><code>bash
sudo mkfs.ext2 ${card}1
sudo mkfs.ext4 ${card}2</code></p>

<ul>
<li>Copiado de los datos a la tarjeta SD:</li>
</ul>

<p><code>bash
mkdir /tmp/sdb1 /tmp/sdb2
sudo mount -t ext2 ${card}1 /tmp/sdb1
sudo mount -t ext4 ${card}2 /tmp/sdb2
sudo tar -C /tmp/sdb1 -xvf bootfs-part1.tar.gz
sudo tar -C /tmp/sdb2 -xvf rootfs-part2.tar.gz
sync
sudo umount /tmp/sdb1
sudo umount /tmp/sdb2</code></p>

<h3 id="configuracion-del-sistema-operativo">5.2.2.3 Configuración del sistema operativo</h3>

<h4 id="configuracion-del-teclado-en-espanol">5.2.2.3.1 Configuración del teclado en español:</h4>

<p>Para esto ejecutamos el siguiente comando:</p>

<p><code>bash
sudo dpkg-reconfigure keyboard-configuration</code></p>

<p>Este comando se encarga de lanzar la aplicación de reconfiguración del teclado.
Seleccionamos <strong>Generic 105 key (Intl PC)</strong>, el idioma <strong>Spanish</strong> y luego las opciones predeterminadas con <strong>OK</strong>.</p>

<h4 id="configuracion-de-red">5.2.2.3.2 Configuración de red:</h4>

<p>En mi caso no la he tocado, ya que uso el DHCP, que es la configuración que viene por defecto.</p>

<h4 id="configuracion-de-la-zona-horaria">5.2.2.3.3 Configuración de la zona horaria:</h4>

<p>Para esto ejecutamos el siguiente comando:</p>

<p><code>bash
sudo dpkg-reconfigure tzdata</code></p>

<p>Este comando se encarga de lanzar la aplicación de reconfiguración de la zona horaria.
Seleccionamos la zona geográfica <strong>Europe</strong> y la zona horaria <strong>Madrid</strong>.</p>

<h4 id="cambio-del-nombre-a-la-cubieboard">5.2.2.3.4 Cambio del nombre a la cubieboard:</h4>

<p>Para esto tenemos que crear/modificar el fichero <strong>/etc/hosts</strong> y añadir el nombre que deseemos que tenga la cubieboard.</p>

<p>Para ello ejecutaremos el siguiente comando:
<code>bash
sudo nano/etc/hosts</code></p>

<p>Y añadiremos la siguiente línea, donde <em>cubieboard</em> es el nombre que le asignaremos:</p>

<p><code>127.0.0.1 cubieboard</code></p>

<h4 id="montado-del-disco-duro">5.2.2.3.5 Montado del disco duro:</h4>

<p>En mi caso el disco duro es <strong>/dev/sda1</strong>.
El disco duro se va a montar sobre la carpeta <strong>/media/hdd</strong>.
Para montar el disco duro y que la configuración se guarde entre arranques del sistema operativo se ha de modificar el fichero <strong>/etc/fstab</strong>. Para ello añadiremos la siguiente línea a dicho fichero.</p>

<p><code>/dev/sda1 /media/hdd ext4 defaults 0 2</code></p>

<h1 id="instalacion-y-configuracion-del-bitorrent-sync">Capítulo 5.2 Instalación y configuración del Bitorrent Sync</h1>

<h2 id="consideraciones-iniciales-2">5.2.1 Consideraciones iniciales</h2>

<p>Las consideraciones inciales son las siguientes:</p>

<ul>
<li>El BitTorrent Sync lo descargo dentro de la carpeta <strong>/home/linaro/Downloads/</strong> y se descomprime dentro de <strong>/home/linaro/Downloads/btsync</strong>.</li>
<li>El binario lo dejo dentro de la carpeta <strong>/usr/local/bin/</strong>.</li>
<li>La configuración del programa está en el fichero <strong>/etc/btsync/btsync.conf</strong>.</li>
<li>Tengo un script de arranque del programa, para que este arranque al arrancar el sistema operativo.</li>
<li>El disco duro se ha montado sobre la carpeta: <strong>/media/hdd/</strong>.</li>
</ul>

<h2 id="proceso-de-instalacion">5.2.2 Proceso de instalación</h2>

<ul>
<li>Descarga del Bittorrent Sync.</li>
</ul>

<p><code>bash
wget http://download-new.utorrent.com/endpoint/btsync/os/linux-arm/track/stable
mkdir btsync
mv stable btsync_arm.tar.gz
tar zxvf btsync_arm.tar.gz -C btsync</code></p>

<ul>
<li>Creamos variables del sistema para ayudarnos en la creación</li>
</ul>

<p><code>bash
config="/etc/btsync/btsync.conf"
user="root"</code></p>

<ul>
<li>Comando a ejecutar para que el programa arranque, en mi caso ha hecho falta, aunque no siempre es preciso. Este paso consiste en linkar el nombre de una librería, para que el programa pueda encontrarla. Esto es necesario para cuando se lance el comando del punto siguiente y este de un error.</li>
</ul>

<p><code>bash
ln -s /lib/arm-linux-gnueabihf/ld-linux.so.3 /lib/ld-linux.so.3</code></p>

<ul>
<li>Extracción del fichero de configuración por defecto.</li>
</ul>

<p><code>bash
btsync --dump-sample-config &gt; $config</code></p>

<ul>
<li>Reconfiguración del fichero de configuración por defecto. Para ello se lanzan los siguientes comandos.</li>
</ul>

<p><code>bash
sed -i 's/"device_name"\s*:\s*"My Sync Device"/"device_name": "CUBIEBOARD"/g' $config
sed -i 's/"storage_path"\s*:\s*"\/home\/user\/\.sync"/"storage_path": "\/media\/hdd\/btsync"/g' $config
sed -i 's/"login"\s*:\s*"admin",//g' $config
sed -i 's/"password"\s*:\s*"password"//g' $config
sed -i 's/:8888",/:8888"/g' $config</code></p>

<p>Como puede observarse se han cambiado los parámetros <em>device_name</em>, <em>storage_path</em>, <em>login</em> y <em>password</em>. Los comandos anteriores tambien pueden cambiarse por un simple <code>nano $config</code> y cambiar los parámetros de forma manual. De todas formas es recomandable lanzar este último parámetro para revisar la configuración y ver si se quiere cambiar algún parámetro más.</p>

<ul>
<li>Creación del script de arranque automático.</li>
</ul>

<p><code>bash
mkdir /var/run/btsync/
nano /etc/init.d/btsync</code></p>

<p>El contenido del fichero <code>/etc/init.d/btsync</code> es el siguiente:</p>

<p>``` bash</p>

<h1 id="bin-sh">Capítulo 5.2 ! /bin/sh</h1>

<h3 id="begin-init-info">5.2.0.1 BEGIN INIT INFO</h3>

<h1 id="provides-btsync">Capítulo 5.2 Provides: btsync</h1>

<h1 id="required-start-syslog-remote-fs">Capítulo 5.2 Required-Start: $syslog $remote_fs</h1>

<h1 id="required-stop-syslog-remote-fs">Capítulo 5.2 Required-Stop: $syslog $remote_fs</h1>

<h1 id="should-start-local-fs">Capítulo 5.2 Should-Start: $local_fs</h1>

<h1 id="should-stop-local-fs">Capítulo 5.2 Should-Stop: $local_fs</h1>

<h1 id="default-start-2-3-4-5">Capítulo 5.2 Default-Start: 2 3 4 5</h1>

<h1 id="default-stop-0-1-6">Capítulo 5.2 Default-Stop: 0 1 6</h1>

<h1 id="short-description-btsync-bittorent-syncapp">Capítulo 5.2 Short-Description: btsync - Bittorent SyncApp</h1>

<h1 id="description-btsync-bittorent-syncapp">Capítulo 5.2 Description: btsync - Bittorent SyncApp</h1>

<h3 id="end-init-info">5.2.0.1 END INIT INFO</h3>

<p>user=root
group=root</p>

<h1 id="the-full-path-to-the-filename-where-you-store-your-rtorrent-configuration">Capítulo 5.2 the full path to the filename where you store your rtorrent configuration</h1>

<p>config="/etc/btsync/btsync.conf"</p>

<h1 id="set-of-options-to-run-with">Capítulo 5.2 set of options to run with</h1>

<p>options=""</p>

<p>PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
DAEMON=/usr/local/bin/btsync
DAEMON_ARGS="--config \$config"
NAME=btsync
DESC=btsync</p>

<p>RUNDIR=/var/run/syncapp
PIDFILE=/var/run/btsync.pid</p>

<p>test -x \$DAEMON || exit 0</p>

<p>if [ -r /etc/default/\$NAME ]
then
. /etc/default/\$NAME
fi</p>

<p>set -e</p>

<p>case "\$1" in
    start)
    echo -n "Starting \$DESC: "
    mkdir -p \$RUNDIR
    touch \$PIDFILE
    chown \$user:\$group \$RUNDIR \$PIDFILE
    chmod 755 \$RUNDIR</p>

<pre><code>if [ -n "\$ULIMIT" ]
then
ulimit -n \$ULIMIT
fi

if start-stop-daemon --start --quiet --umask 007 --pidfile \$PIDFILE --chuid \$user:\$group --exec \$DAEMON -- \$DAEMON_ARGS
then
echo "\$NAME."
else
echo "failed"
fi
;;

stop)
echo -n "Stopping \$DESC: "
killall -w btsync || true
sleep 1
rm -f \$PIDFILE || true
;;

status)
echo -n "\$DESC is "
if start-stop-daemon --stop --quiet --signal 0 --name \${NAME} --pidfile \${PIDFILE}
then
echo "running"
else
echo "not running"
exit 1
fi
;;

*)
echo "Usage: /etc/init.d/\$NAME {start|stop|status}" &gt;&amp;2
exit 1
;;
</code></pre>

<p>esac</p>

<p>exit 0
```</p>

<ul>
<li>Arranque del programa</li>
</ul>

<p><code>bash
chmod +x /etc/init.d/btsync
update-rc.d btsync defaults</code></p>

<h2 id="actualizacion-del-bittorrent-sync">5.2.1 Actualización del Bittorrent Sync</h2>

<p>Para actualiar el programa me he creado el siguiente script, este se encuentra dentro de <strong>/home/linaro/Downloads/</strong>. El mismo script se encarga de descargar, extraer, mover el ejecutable y reiniciar el servicio.
El script es el siguiente:</p>

<p>``` bash</p>

<h1 id="bin-bash">Capítulo 5.2 !/bin/bash</h1>

<p>rm -Rf btsync
mkdir btsync</p>

<p>wget http://download-new.utorrent.com/endpoint/btsync/os/linux-arm/track/stable</p>

<p>mv stable btsync_arm.tar.gz
tar zxvf btsync_arm.tar.gz -C btsync</p>

<p>service btsync stop</p>

<p>cp ./btsync/btsync /usr/local/bin/</p>

<p>service btsync start
```</p>

<h2 id="informacion-obtenida-de">5.2.1 Información obtenida de:</h2>

<p><a href="http://docs.cubieboard.org/tutorials/ct1/installation/install_lubuntu_desktop_server_to_sd_card">Instalación del linux en la SD</a></p>

<p><a href="https://www.imai-solutions.com/cubieboard-lubuntu">Configuración del linux</a></p>

<p><a href="http://quadfinity.blogspot.com.es/2013/11/Install-BitTorrent-Sync-on-Cubieboard-A10.html">Configuración del bittorrent sync</a></p>

<p><a href="https://help.ubuntu.com/community/Fstab">Fstab</a></p>

    </div>

    <div class="span3">
        <div class="item local_toc">
            <h3>Índice de contenidos</h3>

            <ul class="unstyled">
                                                <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#2014_02">Pasos seguidos para crear un sistema de backup online usando el BitTorrent y una Cubietruck (Cubieboard 3)</a>
                    </li>
                                    <li class="level-2">
                        <span>5.2.1</span>
                        <a class="internal" href="./capitulo-52.html#consideraciones-iniciales-sobre-el-documento">Consideraciones iniciales sobre el documento</a>
                    </li>
                                    <li class="level-2">
                        <span>5.2.2</span>
                        <a class="internal" href="./capitulo-52.html#instalacion-del-sistema-operativo-en-tarjeta-sd">Instalación del sistema operativo en tarjeta SD</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#instalacion-y-configuracion-del-bitorrent-sync">Instalación y configuración del Bitorrent Sync</a>
                    </li>
                                    <li class="level-2">
                        <span>5.2.1</span>
                        <a class="internal" href="./capitulo-52.html#consideraciones-iniciales-2">Consideraciones iniciales</a>
                    </li>
                                    <li class="level-2">
                        <span>5.2.2</span>
                        <a class="internal" href="./capitulo-52.html#proceso-de-instalacion">Proceso de instalación</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#bin-sh">! /bin/sh</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#provides-btsync">Provides: btsync</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#required-start-syslog-remote-fs">Required-Start: \$syslog \$remote_fs</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#required-stop-syslog-remote-fs">Required-Stop: \$syslog \$remote_fs</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#should-start-local-fs">Should-Start: \$local_fs</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#should-stop-local-fs">Should-Stop: \$local_fs</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#default-start-2-3-4-5">Default-Start: 2 3 4 5</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#default-stop-0-1-6">Default-Stop: 0 1 6</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#short-description-btsync-bittorent-syncapp">Short-Description: btsync - Bittorent SyncApp</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#description-btsync-bittorent-syncapp">Description: btsync - Bittorent SyncApp</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#the-full-path-to-the-filename-where-you-store-your-rtorrent-configuration">the full path to the filename where you store your rtorrent configuration</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#set-of-options-to-run-with">set of options to run with</a>
                    </li>
                                    <li class="level-2">
                        <span>5.2.1</span>
                        <a class="internal" href="./capitulo-52.html#actualizacion-del-bittorrent-sync">Actualización del Bittorrent Sync</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-52.html#bin-bash">!/bin/bash</a>
                    </li>
                                    <li class="level-2">
                        <span>5.2.1</span>
                        <a class="internal" href="./capitulo-52.html#informacion-obtenida-de">Información obtenida de:</a>
                    </li>
                                        </ul>
        </div>
    </div>
</div>
</div>
</body>
</html>