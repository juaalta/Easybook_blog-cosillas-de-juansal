<!doctype html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="author" content="Juan Salvador Aleixandre" />
    <meta name="date" content="09/11/2015"/>
    <meta name="generator" content="easybook 4.9.0"/>

    <title>Sistema de apertura de un escaparate con arduino | Blog Cosillas de Juansal</title>

    <link rel="stylesheet" href="./css/easybook.css" />

</head>

<body class="item chapter">
<div class="container">
<div class="menu">
    <div class="row">
        <h1 class="span9"><a href="./index.html">Blog Cosillas de Juansal</a></h1>
        <p class="span3">
                        <a href="./capitulo-617.html"><span>&larr;</span> Anterior</a>
            
                        <a href="./capitulo-618.html">Siguiente <span>&rarr;</span></a>
                    </p>
    </div>
</div>

<div class="row">
    <div class="span9">
        <h1 id="2015_18"><span>Capítulo 6.18</span> Sistema de apertura de un escaparate con arduino</h1>
        <h2 id="descripcion">6.18.1 Descripción</h2>

<p>La finalidad del proyecto es crear un sistema selectivo de apertua de escaparates.</p>

<p>Los requerimientos son los siguientes:
- Hay un total de 8 escaparates.
- Se han de poder abrir cada uno de los 8 escaparates de forma independiente.
- Se han de poder abrir todos los escaparates a la vez.
- El tiempo durante el cual los cerrojos deben de estar abiertos es de 1 minuto.
- Hay 3 cerrojos por escaparate.</p>

<div class="figure" id="figure-618-1">
    <img src="images/IMG-20150816-WA0000.jpg" alt="Escaparate" />

    <p class="caption"><strong>Figura 6.18.1</strong> Escaparate</p>
</div>


<h2 id="instrucciones">6.18.2 Instrucciones</h2>

<h3 id="componentes-usados">6.18.2.1 Componentes usados</h3>

<p>Los componentes usados han sido:</p>

<ul>
<li><a href="http://www.kitprinter3d.com/es/electronica/99-fuente-de-alimentacion-conmutada-12v-30a.html">Fuente de alimentación de 12V y 30A</a></li>
<li><a href="http://www.ebay.es/itm/311064700128?_trksid=p2060353.m2749.l2649&amp;ssPageName=STRK%3AMEBIDX%3AIT">Arduino nano v 3.0 5v</a></li>
<li><a href="http://www.aliexpress.com/item/10pcslot-LM2596s-DC-DC-step-down-power-supply-module-3A-adjustable-step-down-module-LM2596-voltage/1289330336.html">Reductor voltaje LM2596s</a></li>
<li><a href="http://www.ereshop.com/shop/relays-c-143_178/i2c-bus-high-current-relay-12v-pcf8574-p-739.html">Bloque relés I2C 12v 10A</a></li>
<li><a href="https://www.ereshop.com/shop/index.php?main_page=product_info&amp;cPath=68_185&amp;products_id=803&amp;zenid=bad04c23e16790298fa3003dd156a414">Teclado 4 x 3</a></li>
<li><a href="http://es.aliexpress.com/item/5pcs-9-15-cm-Printed-Circuit-Board-9X15-cm-Universal-PCB-Board-Double-Sided-Prototype-PCB/32254187154.html?adminSeq=221739572&amp;shopNumber=1403485">Placa PCB 9x15 mm</a></li>
<li><a href="https://www.ereshop.com/shop/index.php?main_page=product_info&amp;cPath=177&amp;products_id=798&amp;zenid=bad04c23e16790298fa3003dd156a414">4-pin 2.00mm connector</a></li>
<li><a href="https://www.ereshop.com/shop/index.php?main_page=product_info&amp;cPath=173&amp;products_id=743&amp;zenid=bad04c23e16790298fa3003dd156a414">4W 2.00mm 4F/4F 6"</a></li>
<li>2 resistencias de 10K</li>
<li><a href="http://es.aliexpress.com/wholesale?catId=0&amp;initiative_id=SB_20151102121134&amp;SearchText=solenoid+door+lock+12v+0.8a">Cerrojo</a></li>
</ul>

<div class="figure" id="figure-618-2">
    <img src="images/Cerrojo.jpg" alt="Cerrojo" />

    <p class="caption"><strong>Figura 6.18.2</strong> Cerrojo</p>
</div>


<h3 id="montaje-del-circuito">6.18.2.2 Montaje del circuito</h3>

<p>El esquema en Fritzing es el siguiente:</p>

<div class="figure" id="figure-618-3">
    <img src="images/Vitrinas_tienda_bb.png" alt="Esquema usando Fritzing" />

    <p class="caption"><strong>Figura 6.18.3</strong> Esquema usando Fritzing</p>
</div>


<p>Como puede observarse en las siguientes imágenes ha sido montado sobre una placa pcb de 9x15.
La fuente de alimentación se ha elegido de 30A porque cada uno de los cerrojos usa 900 mA y hay 24 de estos.
El móldulo LM2596s ha sido usado para reducir el voltaje de entrada a el arduino de 12V a 6V.</p>

<p>Imágenes del sistema montado dentro del laboratorio:</p>

<div class="figure" id="figure-618-4">
    <img src="images/Galeria_01.JPG" alt="Detalle superior de la placa montada" />

    <p class="caption"><strong>Figura 6.18.4</strong> Detalle superior de la placa montada</p>
</div>


<div class="figure" id="figure-618-5">
    <img src="images/Galeria_02.JPG" alt="Detalle inferior de la placa montada" />

    <p class="caption"><strong>Figura 6.18.5</strong> Detalle inferior de la placa montada</p>
</div>


<div class="figure" id="figure-618-6">
    <img src="images/Galeria_03.jpg" alt="Teclado y bloque de relés" />

    <p class="caption"><strong>Figura 6.18.6</strong> Teclado y bloque de relés</p>
</div>


<div class="figure" id="figure-618-7">
    <img src="images/Galeria_04.JPG" alt="Conexión del bloque de relés" />

    <p class="caption"><strong>Figura 6.18.7</strong> Conexión del bloque de relés</p>
</div>


<div class="figure" id="figure-618-8">
    <img src="images/Galeria_05.JPG" alt="Sistema completo" />

    <p class="caption"><strong>Figura 6.18.8</strong> Sistema completo</p>
</div>


<h3 id="software">6.18.2.3 Software</h3>

<p>Para comprobar la dirección I2C del bloque de relés se ha usado el programa llamado <a href="http://todbot.com/blog/2009/11/29/i2cscanner-pde-arduino-as-i2c-bus-scanner/">Arduino I2c Scanner</a>.</p>

<p>Las librerías usadas han sido:</p>

<ul>
<li><a href="http://whatsbroken.com.au/arduino-i2c-relays/i2c_rl8xxm/">I2C_RL8xxM</a>: librería usada para acceder al bloque de relés.</li>
<li>Wire: librería usada para las conexiones I2C y dependencia de la librería I2C_RL8xxM.</li>
<li><a href="http://www.arduino.cc/playground/uploads/Code/Keypad.zip">keypad</a>: librería usada para la gestión del teclado 4x3.</li>
</ul>

<p>El código del arduino es el siguiente:</p>

<p>``` cpp</p>

<h1 id="include-ltwireh">Capítulo 6.18 include &lt;Wire.h></h1>

<h1 id="include-lti2c-rl8xxmh">Capítulo 6.18 include &lt;I2C_RL8xxM.h></h1>

<h1 id="include-ltkeypadh">Capítulo 6.18 include &lt;Keypad.h></h1>

<p>/**
Filas y columnas del teclado
*/
const byte ROWS = 4;
const byte COLS = 3;</p>

<p>/**
@brief Asignación de pins de las patas
*/
byte rowPins[ROWS] = {9, 8, 7, 6};
byte colPins[COLS] = {5, 4, 3};</p>

<p>/**
@brief Define los simbolos de los botones del teclado
<em>/
char Keys[ROWS][COLS] =
{
  {'1', '2', '3'},
  {'4', '5', '6'},
  {'7', '8', '9'},
  {'</em>', '0', '#'}
};</p>

<p>/**
@brief Inicializa el teclado
*/
Keypad keypad = Keypad(makeKeymap(Keys), rowPins, colPins, ROWS, COLS);</p>

<p>char key;</p>

<p>//Tiempo restante de botones
int botones[8] = { 0, 0, 0, 0, 0, 0, 0, 0};</p>

<p>int estadoBotones[8] = {0, 0, 0, 0, 0, 0, 0, 0}; // 0 es desactivado y 1 es activado.</p>

<p>int segundosEspera = 60;</p>

<p>//Se declara una variable que almacenará el tiempo actual (real) transcurrido
//desde que se enciende la placa.
unsigned long tiempo = 0;</p>

<p>//Se declara una variable que almacenará el último valor de tiempo en el que se
//ejecutó la instrucción (delay).
unsigned long t_actualizado = 0;</p>

<p>//Se declara una variable que almacenará el tiempo que se desea que dure el delay.
unsigned long t_delay = 1000; // Por ser milisegundos, nos esperamos un segundo.</p>

<p>int DirReles = 32;</p>

<p>I2C_RL8xxM rb (DirReles);</p>

<p>int pinLed = 13;</p>

<p>void setup()
{
  Serial.begin(9600); //Para debug
  Serial.println("Inicio");</p>

<p>Wire.begin(); //Inicializa el I2C como master
  keypad.addEventListener(keypadEvent); // Añade un gestor de eventos para el teclado</p>

<p>pinMode(13, OUTPUT);
}</p>

<p>void activaRele(int numRele)
{
  Serial.print("Rele activado: ");
  Serial.println(numRele);</p>

<p>if (estadoBotones[numRele - 1] == 0)
  {
    estadoBotones[numRele - 1] = 1;
    botones[numRele - 1] = segundosEspera + 2;</p>

<pre><code>rb.Switch (numRele, true);
</code></pre>

<p>}
  Serial.println("Rele activado: FIN");
}</p>

<p>void apagaRele(int numRele)
{
  Serial.print("Rele desactivado: ");
  Serial.println(numRele);</p>

<p>if (estadoBotones[numRele - 1] == 1)
  {
    estadoBotones[numRele - 1] = 0;</p>

<pre><code>rb.Switch (numRele, false);
</code></pre>

<p>}
  Serial.println("Rele desactivado: FIN");
}</p>

<p>/**
Gestión de la tecla pulsada
*/
void keypadEvent(KeypadEvent key)
{
  Serial.print("Tecla pulsada: ");
  Serial.println(key);</p>

<p>switch (keypad.getState()) {
    case PRESSED: //pulsado + soltado
      Serial.println("PRESSED");
      digitalWrite(13, HIGH);
      if (key == '0')
      {
        activaRele(1);
        activaRele(2);
        activaRele(3);
        activaRele(4);
        activaRele(5);
        activaRele(6);
        activaRele(7);
        activaRele(8);
      } else if (key == '1')
      {
        activaRele(1);
      } else if (key == '2')
      {
        activaRele(2);
      } else if (key == '3')
      {
        activaRele(3);
      } else if (key == '4')
      {
        activaRele(4);
      } else if (key == '5')
      {
        activaRele(5);
      } else if (key == '6')
      {
        activaRele(6);
      } else if (key == '7')
      {
        activaRele(7);
      } else if (key == '8')
      {
        activaRele(8);
      } else if (key == '9')
      {</p>

<pre><code>  } else if (key == '#')
  {

  } else if (key == '*')
  {
  }
  break;

case RELEASED: //Soltado
  Serial.println("RELEASED");
  digitalWrite(13, LOW);
  break;

case HOLD: //Mantenido el botón pulsado
  Serial.println("HOLD");
  break;
</code></pre>

<p>}
}</p>

<p>void testReles()
{
  for (int i = 0; i &lt; 8; i++)
  {
    if (botones[i] == 1)
    {
      apagaRele(i + 1);
    }
    if (botones[i] > 0)
    {
      botones[i]--;
    }
  }
  //Serial.println("Comprobación estado relés");
}</p>

<p>//Se quita, si no el SoftTimer no funciona. Este lo tiene definido dentro.
void  loop()
{
  key = keypad.getKey();
  /*
    if (key) {
      Serial.print("Tecla pulsada: ");
      Serial.println(key);
    }*/</p>

<p>//Se almacena el tiempo que ha transcurrido desde que se encendió el Arduino.
  tiempo = millis();</p>

<p>//Si ese tiempo es mayor que el intervalo de deseado (equivalente al tiempo
  //de delay) se actualiza el intervalo y se ejecutan las instruciones relacionadas.
  //La idea detrás de este algoritmo consiste en pensar que si han transcurrido
  //20ms y se desea un delay de 30ms cada vez, cuando se superen esos 30ms la
  //variable con la que se compara pasa a ser 60ms. Una vez se alcanzan los 60ms
  //pasa a ser 90ms y así sucesivamente.
  if ( tiempo > t_actualizado + t_delay)
  {
    //Se actualiza el tiempo que ha de transcurrir para el próximo delay.
    t_actualizado = tiempo;</p>

<pre><code>testReles();
</code></pre>

<p>}</p>

<p>}
```</p>

    </div>

    <div class="span3">
        <div class="item local_toc">
            <h3>Índice de contenidos</h3>

            <ul class="unstyled">
                                                <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-618.html#2015_18">Sistema de apertura de un escaparate con arduino</a>
                    </li>
                                    <li class="level-2">
                        <span>6.18.1</span>
                        <a class="internal" href="./capitulo-618.html#descripcion">Descripción</a>
                    </li>
                                    <li class="level-2">
                        <span>6.18.2</span>
                        <a class="internal" href="./capitulo-618.html#instrucciones">Instrucciones</a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-618.html#include-ltwireh">include &lt;Wire.h></a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-618.html#include-lti2c-rl8xxmh">include &lt;I2C_RL8xxM.h></a>
                    </li>
                                    <li class="level-1">
                        <span></span>
                        <a class="internal" href="./capitulo-618.html#include-ltkeypadh">include &lt;Keypad.h></a>
                    </li>
                                        </ul>
        </div>
    </div>
</div>
</div>
</body>
</html>